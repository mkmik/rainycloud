<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>Serializer.scala</title>
  <link rel="stylesheet" href="../.docco/main.css"/>
  <script type="text/javascript" src="../.docco/highlight.js">
  </script>
  <script type="text/javascript">
    hljs.initHighlightingOnLoad();
  </script>
</head>
<body>
<div id="container">
  <div id="background"></div>
  <table cellspacing="0" cellpadding="0">
    <thead>
    <tr>
      <th class="docs">
        <h1><a href="../index.html" title="Back to index">&larr;</a>&nbsp;&nbsp;Serializer.scala</h1>
      </th>
      <th class="code"></th>
    </tr>
    </thead>
    <tbody>
    <tr id="section-0">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-0">#</a>
        </div>
      <p></p>
      </td>
      <td class="code">
        <pre><code>package it.cnr.aquamaps

import com.google.inject._
import com.google.inject.name._

import com.googlecode.avro.marker._

import java.io._
import resource._</code></pre>
      </td>
    </tr>
    <tr id="section-1">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-1">#</a>
        </div>
      <p>! Let's define a way to serialize our records in a compact byte stream.</p>
      </td>
      <td class="code">
        <pre><code>trait Serializer[A] {
  def serialize(record: A): Array[Byte]
  def deserialize(bytes: Array[Byte]): A
}</code></pre>
      </td>
    </tr>
    <tr id="section-2">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-2">#</a>
        </div>
      <p>! Avro is a very fast and compact serializer which has some rough edges. In particular records have
 to implement the AvroRecord interface, have only mutable fields, and provide an empty constructor.</p>
      </td>
      <td class="code">
        <pre><code>abstract class AvroSerializer[A &lt;: AvroRecord] @Inject() extends Serializer[A] {
  def makeRecord: A
  def serialize(record: A): Array[Byte] = record.toBytes
  def deserialize(bytes: Array[Byte]): A = makeRecord.parse(bytes)
}</code></pre>
      </td>
    </tr>
    <tr id="section-3">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-3">#</a>
        </div>
      <p>! We use implicits to get an empty record when needed</p>
      </td>
      <td class="code">
        <pre><code>object AvroSerializer {
  def apply[A &lt;: AvroRecord]()(implicit a: A): AvroSerializer[A] = new AvroSerializer[A] { def makeRecord = a }
}</code></pre>
      </td>
    </tr>
    <tr id="section-4">
      <td class="docs">
        <div class="octowrap">
          <a class="octothorpe" href="#section-4">#</a>
        </div>
      <p>! Otherwise we can rely on good old java serialization</p>
      </td>
      <td class="code">
        <pre><code>class SerializableSerializer[A] @Inject() extends Serializer[A] {
  def serialize(record: A): Array[Byte] = {
    val baos = new ByteArrayOutputStream(1024)
    val res = for (o &lt;- managed(new ObjectOutputStream(baos)))
      o writeObject record

    baos.toByteArray
  }

  def deserialize(bytes: Array[Byte]): A = {
    val res = for (o &lt;- managed(new ObjectInputStream(new ByteArrayInputStream(bytes))))
      yield o.readObject.asInstanceOf[A]
    res.opt.get
  }
}</code></pre>
      </td>
    </tr>
  </table>
</div>
</body>
</html>